import structlog

from util.constants import SUPPORTED_SHARING, EPSILON, SNR_NOISE_LOW, SNR_NOISE_HIGH, B_IN_MB, BITS_IN_BYTE, \
    SNR_NOISE_UNIT, TOTAL_VIDEO_CHUNKS
import numpy as np

SNR_THRESHOLD = 2e-8
TMP_SNR = [
[1, 1.0324820482412824, 0.9916909536727629, 0.9675356498666057, 0.9621060197135453, 0.95476002018905, 0.9508952097355192, 0.9784841437694646, 0.9748551338511553, 0.9539530334978561, 0.9605167158068353, 0.9140059914907759, 0.9488254613308613, 0.9662103639794009, 1.00945335409377, 1.0265722444389196, 1.0111224513069306, 1.0444174179554444, 1.0156777721645343, 1.0017037500442851, 1.0242251091460977, 0.9813823053803313, 1.000089090307532, 0.9816407008949428, 0.9754438625315139, 0.9906687224983082, 1.0167252116122567, 1.0524901943452563, 1.080221468781823, 1.0885029419198715, 1.1301965302146308, 1.0941533792057858, 1.111299955346517, 1.0979253688187034, 1.0879545018174235, 1.1267266886940184, 1.152586816304272, 1.1168696713646311, 1.0693437660330294, 1.0862911163312277, 1.0443735044097422, 1.0701106383589858, 1.0697439181672508, 1.110470596636246, 1.1479038749313395, 1.187818134304708, 1.2, 1.2, 1.2, 1.2],
[1, 1.1526033039804822, 1.142590896149674, 1.1312896053125965, 1.1584954825364289, 1.113885489067208, 1.145646901657716, 1.1952129665413889, 1.2, 1.2, 1.181295074730825, 1.1840416686414743, 1.147943824113745, 1.1237681001770068, 1.167238086336704, 1.176987176360746, 1.2, 1.2, 1.1845717427404174, 1.2, 1.198024128348586, 1.1801643509241466, 1.1521317465011358, 1.1409778574306915, 1.093311226767442, 1.1187285664576896, 1.0937753962977088, 1.1169541550317743, 1.0854802685705451, 1.0664093872043277, 1.1159605751055486, 1.1090490656444043, 1.158901568755691, 1.1492925365549764, 1.1652683399128403, 1.1204408180688514, 1.0887321585739727, 1.0787703452017767, 1.0449540723181574, 1.0432252018946249, 1.0782128697445994, 1.0914674505057005, 1.1245320462402086, 1.1301296388470154, 1.1095109191305557, 1.1436019024562265, 1.1155021550386395, 1.1449422726395557, 1.1474295767421245, 1.1705767991990894],
[1, 0.9693796116053275, 0.9341907377656433, 0.9005779778235357, 0.8546948803859354, 0.8766743657225691, 0.8553099704265902, 0.9020355306912343, 0.9170024989204488, 0.8721315263317918, 0.8883467069029747, 0.9055691374364625, 0.9516955686695879, 0.9289682631703484, 0.9520782281035571, 0.946950015792565, 0.9300313253606314, 0.9794762337553367, 1.0026659614486704, 0.9792555603106423, 0.9942831013902442, 0.9974155203896674, 1.0299880836474935, 1.0501461765463036, 1.0236233383114137, 1.0549068913712418, 1.093482286374358, 1.0518084414048015, 1.008998786029007, 0.9691017054245256, 0.9792731559099727, 0.96557175581224, 1.0150116239969733, 1.0416301634376322, 1.057848813394175, 1.032477780372493, 1.0676050454369443, 1.107541837396145, 1.101144224875048, 1.0570294080135607, 1.0761541570296829, 1.0368265023819678, 1.071224854549585, 1.1002033950695564, 1.0888459407624569, 1.072664898938948, 1.07480784616401, 1.0851919390494693, 1.0500652879958396, 1.025972012225146],
[1, 1.1179311800895606, 1.0977685008390767, 1.139888928586234, 1.1401257389730395, 1.1898716882216511, 1.15306067271352, 1.1072404275074672, 1.0691831748993619, 1.0916657813921211, 1.1383133790600446, 1.0941936255692872, 1.1066060448350836, 1.1110166996977373, 1.1087608434549638, 1.1217610667480937, 1.1410330019053083, 1.1277590925562542, 1.1453798019357007, 1.1235064829224923, 1.1391308947602983, 1.1782730727310593, 1.1948456939975993, 1.2, 1.1739538324732854, 1.1822087325293968, 1.2, 1.2, 1.1903790818374906, 1.1453419365005097, 1.1624920177891311, 1.2, 1.2, 1.2, 1.1751295221422926, 1.2, 1.161425703566023, 1.1635071315379435, 1.2, 1.2, 1.1772519272580626, 1.1322710185620228, 1.1574085066625326, 1.167503852377777, 1.1812540270621512, 1.167092851847314, 1.1676381233585662, 1.1885231305762878, 1.2, 1.2]
]


class User:
    """A User getting data from the satellite"""
    def __init__(self, agent_id):
        self.agent_id = agent_id


        # self.snr_noise = [np.random.uniform(SNR_NOISE_LOW, SNR_NOISE_HIGH)]
        self.snr_noise = TMP_SNR[self.agent_id]
        self.index = -1

        # just consider downlink for now; more interesting for most apps anyways
        self.log = structlog.get_logger(sat_id=self.agent_id)
        self.log.info('User init', snr_noise=self.snr_noise)

    def __repr__(self):
        return str(self.agent_id)

    def get_snr_noise(self):
        # return self.snr_noise[-1]
        return self.snr_noise[self.index]

    def get_snr_log(self):
        return self.snr_noise

    def update_snr_noise(self):
        """
        self.snr_noise.append(self.snr_noise[-1] + np.random.uniform(-SNR_NOISE_UNIT, SNR_NOISE_UNIT))

        if self.snr_noise[-1] > SNR_NOISE_HIGH:
            self.snr_noise[-1] = SNR_NOISE_HIGH
        elif self.snr_noise[-1] < SNR_NOISE_LOW:
            self.snr_noise[-1] = SNR_NOISE_LOW

        return self.snr_noise[-1]
        """
        self.index += 1
        return self.snr_noise[self.index]

    def get_agent_id(self):
        return self.agent_id
